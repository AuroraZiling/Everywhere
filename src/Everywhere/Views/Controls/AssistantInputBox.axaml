<ResourceDictionary
    xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:extensions="clr-namespace:ShadUI.Extensions;assembly=ShadUI" xmlns:m="clr-namespace:Everywhere.Models"
    xmlns:shadui="clr-namespace:ShadUI.Controls;assembly=ShadUI" xmlns:v="clr-namespace:Everywhere.Views">

    <ControlTheme
        x:Key="{x:Type v:AssistantInputBox}"
        TargetType="v:AssistantInputBox">

        <Style Selector="^ /template/ ToggleButton.Rounded">
            <Setter Property="Height" Value="30"/>
            <Setter Property="MinHeight" Value="30"/>
            <Setter Property="Padding" Value="8,0"/>
            <Setter Property="CornerRadius" Value="15"/>
        </Style>

        <Style Selector="^ /template/ MenuItem.Rounded">
            <Setter Property="Width" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="CornerRadius" Value="15"/>
        </Style>

        <Style Selector="^ /template/ Button.Rounded">
            <Setter Property="Width" Value="30"/>
            <Setter Property="Height" Value="30"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="CornerRadius" Value="15"/>
        </Style>

        <Style Selector="^ /template/ Button#PART_CancelButton:disabled">
            <Setter Property="IsVisible" Value="False"/>
        </Style>

        <Setter Property="Watermark" Value="{DynamicResource AssistantInputBox_Watermark}"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="Padding" Value="6"/>
        <Setter Property="SelectionBrush" Value="{DynamicResource PrimaryColor}"/>
        <Setter Property="SelectionForegroundBrush" Value="{DynamicResource PrimaryForegroundColor}"/>
        <Setter Property="CaretBrush" Value="{DynamicResource ForegroundColor}"/>
        <Setter Property="Template">
            <ControlTemplate>
                <Panel>
                    <shadui:Card
                        Padding="6" BorderThickness="0"
                        CornerRadius="20">
                        <Grid
                            ColumnDefinitions="*,Auto" RowDefinitions="*,Auto,Auto"
                            RowSpacing="4">
                            <Panel
                                Grid.Row="0" Grid.Column="0"
                                Grid.ColumnSpan="2" Margin="6,4,6,0"
                                Background="Transparent">
                                <TextBlock
                                    FontSize="{TemplateBinding FontSize}"
                                    IsVisible="{TemplateBinding Text, Converter={x:Static StringConverters.IsNullOrEmpty}}"
                                    Opacity="0.5"
                                    Text="{TemplateBinding Watermark}"
                                    TextAlignment="{TemplateBinding TextAlignment}"
                                    TextWrapping="{TemplateBinding TextWrapping}"/>
                                <v:AssistantInputTextPresenter
                                    x:Name="PART_TextPresenter"
                                    CaretBrush="{TemplateBinding CaretBrush}"
                                    CaretIndex="{TemplateBinding CaretIndex}"
                                    SelectedAssistantCommand="{Binding $parent[v:AssistantInputBox].SelectedAssistantCommand}"
                                    SelectionBrush="{TemplateBinding SelectionBrush}"
                                    SelectionEnd="{TemplateBinding SelectionEnd}"
                                    SelectionForegroundBrush="{TemplateBinding SelectionForegroundBrush}"
                                    SelectionStart="{TemplateBinding SelectionStart}"
                                    Text="{TemplateBinding Text, Mode=TwoWay}"
                                    TextAlignment="{TemplateBinding TextAlignment}"
                                    TextBlock.FontSize="{TemplateBinding FontSize}"
                                    TextBlock.Foreground="{TemplateBinding Foreground}"
                                    TextWrapping="{TemplateBinding TextWrapping}"/>
                            </Panel>

                            <Popup
                                Grid.Row="0" Grid.Column="0"
                                IsOpen="{Binding IsAssistantCommandFlyoutOpen, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                Placement="TopEdgeAlignedLeft" PlacementTarget="PART_TextPresenter">
                                <ListBox
                                    Background="{DynamicResource CardBackgroundColor}"
                                    CornerRadius="6" Grid.IsSharedSizeScope="True"
                                    ItemsSource="{TemplateBinding AssistantCommandItemsSource}"
                                    SelectedItem="{Binding SelectedAssistantCommand, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}">
                                    <ListBox.DataTemplates>
                                        <DataTemplate DataType="m:AssistantCommand">
                                            <TextBlock>
                                                <Run
                                                    FontWeight="Black"
                                                    Text="{Binding Command}"/>
                                                <Run Text="{Binding DescriptionKey^, FallbackValue={x:Null}}"/>
                                            </TextBlock>
                                        </DataTemplate>
                                    </ListBox.DataTemplates>
                                </ListBox>
                            </Popup>

                            <ItemsControl
                                Grid.Row="1" Grid.Column="0"
                                Grid.ColumnSpan="2" Margin="0,2"
                                ItemsSource="{TemplateBinding AttachmentItemsSource}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel
                                            ItemSpacing="6" LineSpacing="4"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="m:AssistantAttachment">
                                        <Border
                                            Height="24"
                                            Background="{DynamicResource CardBackgroundColor}"
                                            CornerRadius="12">
                                            <StackPanel
                                                Margin="6,0,4,0" Orientation="Horizontal"
                                                Spacing="4">
                                                <LucideIcon
                                                    VerticalAlignment="Center"
                                                    Kind="{Binding Icon}"
                                                    Size="14"/>
                                                <TextBlock
                                                    VerticalAlignment="Center" FontSize="12"
                                                    Text="{Binding HeaderKey^}"/>
                                                <Button
                                                    Padding="1" VerticalAlignment="Center"
                                                    Background="Transparent" BorderThickness="0">
                                                    <LucideIcon
                                                        Foreground="{DynamicResource MutedColor}"
                                                        Kind="X" Size="12"/>
                                                </Button>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <StackPanel
                                Grid.Row="2" Grid.Column="0"
                                Orientation="Horizontal" Spacing="4">
                                <Menu>
                                    <MenuItem
                                        Classes="Outline Rounded"
                                        extensions:MenuItemAssist.Label="{DynamicResource AssistantInputBox_AddAttachmentMenuItem_Header}"
                                        extensions:MenuItemAssist.PopupPlacement="TopEdgeAlignedLeft" extensions:MenuItemAssist.PopupVerticalOffset="-4"
                                        ItemsSource="{TemplateBinding AddAttachmentMenuItems}"
                                        ToolTip.Tip="{DynamicResource AssistantInputBox_AddAttachmentButton_ToolTip}">
                                        <MenuItem.Header>
                                            <LucideIcon
                                                HorizontalAlignment="Center" VerticalAlignment="Center"
                                                Kind="Plus" Size="18"/>
                                        </MenuItem.Header>
                                    </MenuItem>
                                </Menu>

                                <ToggleButton
                                    Classes="Outline Rounded"
                                    IsChecked="{Binding IsImageEnabled, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                    IsVisible="{TemplateBinding IsImageSupported}"
                                    ToolTip.Tip="{DynamicResource AssistantInputBox_ImageButton_ToolTip}">
                                    <StackPanel
                                        Orientation="Horizontal" Spacing="2">
                                        <LucideIcon
                                            Kind="Image" Size="16"/>
                                        <TextBlock Text="{DynamicResource AssistantInputBox_ImageButton_Text}"/>
                                    </StackPanel>
                                </ToggleButton>

                                <ToggleButton
                                    Classes="Outline Rounded"
                                    IsChecked="{Binding IsWebSearchEnabled, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                    IsVisible="{TemplateBinding IsWebSearchSupported}"
                                    ToolTip.Tip="{DynamicResource AssistantInputBox_WebSearchButton_ToolTip}">
                                    <StackPanel
                                        Orientation="Horizontal" Spacing="2">
                                        <LucideIcon
                                            Kind="Globe" Size="16"/>
                                        <TextBlock Text="{DynamicResource AssistantInputBox_WebSearchButton_Text}"/>
                                    </StackPanel>
                                </ToggleButton>

                                <ToggleButton
                                    Classes="Outline Rounded"
                                    IsChecked="{Binding IsToolCallEnabled, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                    IsVisible="{TemplateBinding IsToolCallSupported}"
                                    ToolTip.Tip="{DynamicResource AssistantInputBox_ToolCallButton_ToolTip}">
                                    <StackPanel
                                        Orientation="Horizontal" Spacing="2">
                                        <LucideIcon
                                            Kind="Hammer" Size="16"/>
                                        <TextBlock Text="{DynamicResource AssistantInputBox_ToolCallButton_Text}"/>
                                    </StackPanel>
                                </ToggleButton>
                            </StackPanel>

                            <StackPanel
                                Grid.Row="2" Grid.Column="1"
                                Margin="8,0,0,0" Orientation="Horizontal"
                                Spacing="4">
                                <Button
                                    x:Name="PART_SendButton" Classes="Primary Rounded"
                                    IsVisible="{Binding !IsVisible, ElementName=PART_CancelButton}"
                                    ToolTip.Tip="{DynamicResource AssistantInputBox_SendButton_ToolTip}">
                                    <Button.IsEnabled>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding
                                                Path="IsSendButtonEnabled"
                                                RelativeSource="{RelativeSource TemplatedParent}"/>
                                            <Binding
                                                Converter="{x:Static StringConverters.IsNotNullOrEmpty}"
                                                Path="Text"
                                                RelativeSource="{RelativeSource TemplatedParent}"/>
                                        </MultiBinding>
                                    </Button.IsEnabled>

                                    <LucideIcon
                                        Margin="-1,1,1,-1" Kind="Send"
                                        Size="16"/>
                                </Button>

                                <Button
                                    x:Name="PART_CancelButton" Classes="Primary Rounded"
                                    Command="{TemplateBinding CancelCommand}"
                                    ToolTip.Tip="{DynamicResource AssistantInputBox_CancelButton_ToolTip}">
                                    <Border
                                        Width="12" Height="12"
                                        Background="{DynamicResource ForegroundColor}"
                                        CornerRadius="1"/>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </shadui:Card>

                    <Border
                        BoxShadow="inset 3 6 6 -1.5 #66000000, inset 0 -1.5 1.5 0 #88FFFFFF" CornerRadius="20"
                        IsHitTestVisible="False"/>
                </Panel>
            </ControlTemplate>
        </Setter>
    </ControlTheme>
</ResourceDictionary>